---

# trun off swap permanently

- name: disable swap - step one
  become: yes
  systemd: 
    name: swap.target
    state: stopped
    masked: yes
  changed_when: false

- name: disable swap - step two
  become: yes
  shell:
    cmd: swapoff -a
  changed_when: false


    
# Verify the MAC address and product_uuid are unique for every node




# open required ports  
- name: Install UFW
  dnf:
    name: ufw
    state: present

- name: Start UFW service
  systemd:
    name: ufw
    state: started
    enabled: yes

- name: open port 6443 on target machine
  become: yes
  ufw:
    rule: allow
    port: 6443
    proto: tcp



      
# Installing a container runtime interface (CRI)
- name: install cri-o prerequisits
  dnf:
    name: libseccomp, glibc-langpack-en
    state: present
  when: ansible_distribution == "Fedora"

- name: adding cri-o repo to dnf
  command: dnf config-manager --add-repo=https://cbs.centos.org/repos/paas7-crio-411-candidate/x86_64/os/
  when: ansible_distribution == "Fedora"

- name: install cri-o
  dnf:
    name: cri-o
    state: present
  when: ansible_distribution == "Fedora"


    
# Installing kubeadm, kubelet and kubectl
- name: disable SELinux
  command: sudo setenforce 0
  when: ansible_distribution == "Fedora"

- name: disable SELinux- step two
  command: sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
  when: ansible_distribution == "Fedora"

- name: add gpg key for kubernetes repo
  command: sudo rpm --import https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
  when: ansible_distribution == "Fedora"

- name: adding kubernetes repo
  command: dnf config-manager --add-repo https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
  when: ansible_distribution == "Fedora"

- name: update packages in fedora
  tags: always
  dnf:
    update_cache: yes
  when: ansible_distribution == "Fedora"

- name: install kubectl
  dnf:
    name: kubectl
  when: ansible_distribution == "Fedora"

- name: install kubelet
  dnf:
    name: kubelet
  when: ansible_distribution == "Fedora"

- name: install kubeadm
  dnf:
    name: kubeadm
  when: ansible_distribution == "Fedora"


    
# Configuring a cgroup driver





# start kubernetes cluster
- name: start kubelet service
  become: yes
  command: systemctl start kubelet.service
    
- name: init kubeadm
  become: yes
  command: kubeadm init






    
