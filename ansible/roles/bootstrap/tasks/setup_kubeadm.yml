---
# trun off swap permanently
- name: run swapoff command
  become: yes
  command: swapoff -a
  changed_when: false

- name: Comment out swap entry in /etc/fstab
  lineinfile:
    path: /etc/fstab
    regexp: '.*swap.*'
    line: '#'
  register: swap_disabled
  changed_when: swap_disabled.changed

# Verify the MAC address and product_uuid are unique for every node





# open required ports  
- name: Install UFW
  dnf:
    name: ufw
    state: present

- name: Start UFW service
  systemd:
    name: ufw
    state: started
    enabled: yes

- name: open port 6443 on target machine
  become: yes
  ufw:
    rule: allow
    port: 6443
    proto: tcp


       
# Installing a container runtime interface (CRI)
- name: install cri-o prerequisits
  dnf:
    name: libseccomp, glibc-langpack-en
    state: present
  when: ansible_distribution == "Fedora"

- name: adding cri-o repo to dnf
  command: dnf config-manager --add-repo=https://cbs.centos.org/repos/paas7-crio-411-candidate/x86_64/os/
  when: ansible_distribution == "Fedora"

- name: install cri-o
  dnf:
    name: cri-o
    state: present
  when: ansible_distribution == "Fedora"




# Installing kubeadm, kubelet and kubectl
- name: add gpg key for kubernetes repo
  dnf_key:
    url: "https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch"
    state: present

- name: adding kubernetes repo
  command: dnf config-manager --add-repo=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
  when: ansible_distribution == "Fedora"

- name: disable SELinux
  command: sudo setenforce 0 
  when: ansible_distribution == "Fedora"
    
- name: disable SELinux- step two
  command: sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
  when: ansible_distribution == "Fedora"
     

    #- name: install kubeadm
    #command: sudo dnf install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
    # when: ansible_distribution == "Fedora"

    #- name: enable kubelet service
    #  systemd:
    #    name: kubelet
    #    state: started
    #  enabled: yes




# Configuring a cgroup driver
